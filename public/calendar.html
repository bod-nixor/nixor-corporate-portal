<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="flex">
    <aside class="w-64 min-h-screen bg-slate-900 border-r border-slate-800 p-6 hidden md:block">
      <div class="text-xs uppercase tracking-[0.3em] text-indigo-300">Nixor Portal</div>
      <nav class="mt-8 space-y-2 text-sm">
        <a class="block px-3 py-2 rounded-xl hover:bg-slate-800" href="/dashboard.html">Entity Dashboard</a>
        <a class="block px-3 py-2 rounded-xl hover:bg-slate-800" href="/entity_drive.html">Entity Drive</a>
        <a class="block px-3 py-2 rounded-xl bg-slate-900 text-white" href="/calendar.html">Calendar</a>
        <a class="block px-3 py-2 rounded-xl hover:bg-slate-800" href="/social.html">Social</a>
        <a class="block px-3 py-2 rounded-xl hover:bg-slate-800" href="/endeavours.html">Entities’ Endeavours</a>
        <a class="block px-3 py-2 rounded-xl hover:bg-slate-800" href="/admin.html">Settings</a>
      </nav>
    </aside>
    <main class="flex-1 p-6 md:p-10">
      <header>
        <h1 class="text-2xl font-semibold">Calendar</h1>
        <p class="text-slate-400">Meetings, deadlines, RSVPs, and minutes.</p>
      </header>
      <section class="mt-6 grid grid-cols-1 xl:grid-cols-[2fr_1fr] gap-6">
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Upcoming Events</h2>
            <select id="calendar-entity" class="bg-slate-950 border border-slate-800 rounded-xl px-3 py-2 text-sm"></select>
          </div>
          <div id="calendar-list" class="mt-4 space-y-3 text-sm"></div>
          <p id="calendar-empty" class="hidden text-sm text-slate-500 mt-4">No events scheduled.</p>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6">
          <h2 class="text-lg font-semibold">Add Event</h2>
          <form id="calendar-form" class="mt-4 space-y-3 text-sm">
            <input name="title" required placeholder="Event title" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm" />
            <input name="event_date" type="datetime-local" required class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm" />
            <input name="location" placeholder="Location" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm" />
            <textarea name="description" rows="3" placeholder="Description" class="w-full rounded-xl bg-slate-950 border border-slate-800 px-4 py-3 text-sm"></textarea>
            <div id="calendar-status" class="hidden text-sm rounded-xl px-4 py-3"></div>
            <button class="w-full bg-indigo-500 rounded-xl px-4 py-3 text-sm font-medium" type="submit">Create Event</button>
          </form>
        </div>
      </section>
    </main>
  </div>
  <script type="module">
    import { apiFetch } from '/assets/app.js';
    const entitySelect = document.getElementById('calendar-entity');
    const list = document.getElementById('calendar-list');
    const emptyState = document.getElementById('calendar-empty');
    const form = document.getElementById('calendar-form');
    const statusEl = document.getElementById('calendar-status');

    const normalizeError = (err) => {
      const message = err?.message || '';
      return message === 'Forbidden' ? 'You do not have permission.' : (message || 'Action failed.');
    };

    const setStatus = (message, ok) => {
      statusEl.textContent = message;
      statusEl.className = `text-sm rounded-xl px-4 py-3 ${ok ? 'bg-emerald-500/10 text-emerald-300 border border-emerald-500/30' : 'bg-red-500/10 text-red-300 border border-red-500/30'}`;
      statusEl.classList.remove('hidden');
    };

    const loadEvents = async () => {
      const entityId = entitySelect.value;
      if (!entityId) return;
      try {
        const response = await apiFetch(`/calendar?entity_id=${entityId}`);
        const events = response?.data || [];
        list.innerHTML = '';
        if (!events.length) {
          emptyState.textContent = 'No events scheduled.';
          emptyState.classList.remove('hidden');
          return;
        }
        emptyState.classList.add('hidden');
        events.forEach((event) => {
          const card = document.createElement('div');
          card.className = 'bg-slate-950 border border-slate-800 rounded-xl p-4';
          const title = document.createElement('p');
          title.className = 'font-medium';
          title.textContent = event.title;
          const meta = document.createElement('p');
          meta.className = 'text-xs text-slate-500 mt-1';
          meta.textContent = `${new Date(event.event_date).toLocaleString()} · ${event.location || 'TBD'}`;
          const desc = document.createElement('p');
          desc.className = 'text-xs text-slate-400 mt-2';
          desc.textContent = event.description || 'No description.';
          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(desc);
          list.appendChild(card);
        });
      } catch (err) {
        console.error('Failed to load events:', err);
        list.innerHTML = '';
        emptyState.textContent = 'Failed to load events. Please try again.';
        emptyState.classList.remove('hidden');
      }
    };

    apiFetch('/auth/me')
      .then((response) => {
        const entities = response?.data?.entities || [];
        entitySelect.innerHTML = '';
        entities.forEach((entity) => {
          const option = document.createElement('option');
          option.value = entity.id;
          option.textContent = entity.name;
          entitySelect.appendChild(option);
        });
        if (entities.length) {
          entitySelect.value = entities[0].id;
          loadEvents();
        }
      })
      .catch((err) => {
        console.error('Failed to load entities:', err);
        entitySelect.innerHTML = '';
        emptyState.textContent = 'Unable to load calendar without access.';
        emptyState.classList.remove('hidden');
      });

    entitySelect.addEventListener('change', loadEvents);
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = Object.fromEntries(new FormData(form).entries());
      payload.entity_id = entitySelect.value;
      try {
        await apiFetch('/calendar', { method: 'POST', body: JSON.stringify(payload) });
        setStatus('Event created.', true);
        form.reset();
        loadEvents();
      } catch (err) {
        setStatus(normalizeError(err), false);
      }
    });
  </script>
</body>
</html>
